# Sync Session: 2025-11-21

## Session Info
- **Target**: `8b119e5105906a66cc99264527670c88b07c7a10` (trunk before 4.3.0-SNAPSHOT)
- **Branch**: `sync/upstream-20251121`
- **Started**: 2025-02-05
- **Status**: In Progress

---

## Phase 1: Pre-Merge Analysis

### Target Identification
```bash
# Target commit
git rev-parse 8b119e5105
# Result: 8b119e5105906a66cc99264527670c88b07c7a10
# Message: MINOR: Fix library name jacksonDatabindYaml -> jacksonDataformatYaml (#20937)
# Date: 2025-11-21
# Version at target: 4.2.0-SNAPSHOT
```

### Conflict Preview
```bash
git merge --no-commit 8b119e5105
git diff --name-only --diff-filter=U
# Total: 32 conflicts
```

### Conflict Summary
| Category | Count | Files |
|----------|-------|-------|
| Config/Version | 7 | gradle.properties, build.gradle, gradle/dependencies.gradle, gradle/spotbugs-exclude.xml, docs/js/templateData.js, tests/kafkatest/__init__.py, tests/kafkatest/version.py |
| CI/Other | 3 | .github/workflows/build.yml, committer-tools/kafka-merge-pr.py, docker/docker_build_test.py |
| Core+Inkless | 5 | BrokerServer.scala, ControllerServer.scala, DelayedFetch.scala, KafkaApis.scala, ReplicaManager.scala |
| Deleted by upstream | 3 | EligibleLeaderReplicasIntegrationTest.java, AdminClientWithPoliciesIntegrationTest.scala, ProducerSendWhileDeletionTest.scala |
| Test files | 11 | Various test files with inkless modifications |

---

## Phase 2: Conflict Resolution

### Resolution Order
1. Config/Version files (7)
2. CI/Other files (3)
3. Core + Inkless files (5)
4. Deleted by upstream (3)
5. Test files (11)

### Versioning Rule
**Pattern**: `{upstream_version}-inkless-SNAPSHOT`
- Upstream `4.2.0-SNAPSHOT` → Inkless `4.2.0-inkless-SNAPSHOT`

---

### Config/Version Files
| # | File | Resolution Notes | Status |
|---|------|------------------|--------|
| 1 | gradle.properties | `4.2.0-inkless-SNAPSHOT`, scala 2.13.17 (upstream) | ✅ |
| 2 | build.gradle | Upstream plugin versions + inkless pitest/jooq plugins | ✅ |
| 3 | gradle/dependencies.gradle | Merged: inkless deps (gcsSdk, jooq, testcontainers) + upstream updates (spotbugs 4.9.8, mockOAuth2Server, jfreechart 1.5.6) | ✅ |
| 4 | gradle/spotbugs-exclude.xml | Keep inkless jooq exclusion + all new upstream spotbugs 4.9.4 exclusions | ✅ |
| 5 | docs/js/templateData.js | `42inkless`, `4.2-inkless`, `4.2.0-inkless` | ✅ |
| 6 | tests/kafkatest/__init__.py | `4.2.0.inkless.dev0` | ✅ |
| 7 | tests/kafkatest/version.py | `4.2.0-inkless-SNAPSHOT` | ✅ |

---

### CI/Other Files
| # | File | Resolution Notes | Status |
|---|------|------------------|--------|
| 1 | .github/workflows/build.yml | Upstream Java 25 (jooq classes now in source, no generation needed) | ✅ |
| 2 | committer-tools/kafka-merge-pr.py | Upstream `4.2.0` (one-off) | ✅ |
| 3 | docker/docker_build_test.py | Upstream (one-off - Makefile docker targets replaced dependency) | ✅ |

**One-off files** (no future conflicts expected):
- streams/quickstart/java/pom.xml (x2)
- streams/quickstart/pom.xml
- docker/docker_build_test.py
- committer-tools/kafka-merge-pr.py

---

### Core Files with Inkless Modifications

#### 1. BrokerServer.scala ✅

**Conflicts resolved:**
1. **Imports** (line 20-31):
   - Keep: `import io.aiven.inkless.common.SharedState`
   - Remove: `kafka.coordinator.group.CoordinatorLoaderImpl` (moved to `org.apache.kafka.coordinator.common.runtime`)
   - Keep upstream: `import kafka.coordinator.group.CoordinatorPartitionWriter`

**Inkless additions preserved:**
- `inklessSharedState` creation in startup
- Passing `inklessSharedState` to ReplicaManager and KafkaApis constructors

---

#### 2. ControllerServer.scala ✅

**Conflicts resolved:**
1. **Imports** (line 25):
   - Keep: `InklessMetadataView` from kafka.server.metadata
   - Remove: `DelegationTokenPublisher, DynamicClientQuotaPublisher, ScramPublisher` (moved to `org.apache.kafka.metadata.publisher`)

2. **ControllerApis construction** (line 290-298):
   - Keep inkless: `sharedServer.inklessControlPlane` parameter
   - Accept upstream: `sharedServer.requestHandlerPoolFactory.createPool()` API change

**Inkless additions preserved:**
- `inklessMetadataView` parameter to ControllerApis
- `sharedServer.inklessControlPlane` passed to ControllerApis

---

#### 3. DelayedFetch.scala ✅

**Conflicts resolved:**
1. **Constructor parameters** (line 44-53):
   - Keep inkless: `classicFetchPartitionStatus: Seq[(TopicIdPartition, FetchPartitionStatus)]`
   - Keep inkless: `disklessFetchPartitionStatus: Seq[(TopicIdPartition, FetchPartitionStatus)] = Seq.empty`
   - Reject upstream: `fetchPartitionStatus: util.LinkedHashMap[...]` (incompatible with inkless approach)
   - Keep inkless: `maxWaitMs: Option[Long]` and `minBytes: Option[Int]` parameters

2. **tryComplete method** (line 75-157):
   - Keep inkless: `classicFetchPartitionStatus.foreach { case ... }` pattern
   - Keep inkless: `var accumulatedSize = 0L` (Long for diskless accumulation)
   - Keep inkless: `tryCompleteDiskless()` call
   - Keep inkless: `minBytes.getOrElse(params.minBytes)` check

3. **onComplete method** (line 228-339):
   - Keep inkless: `classicFetchPartitionStatus.map { ... }` for classic fetches
   - Keep inkless: Combined response with diskless fetch results

**Inkless additions preserved:**
- Separate handling of classic vs diskless fetch partitions
- `tryCompleteDiskless()` method for diskless partition completion
- Percentage-based maxBytes adjustment for classic/diskless split
- `fetchDisklessMessages()` call for diskless data retrieval

**Key design difference:**
- Inkless uses `Seq[(TopicIdPartition, FetchPartitionStatus)]` (immutable)
- Upstream uses `util.LinkedHashMap[TopicIdPartition, FetchPartitionStatus]` (mutable)
- Inkless approach required to maintain separate classic/diskless status tracking

---

#### 4. KafkaApis.scala ✅

**Conflicts resolved:**
1. **AddPartitionsToTxn handling** (line 1922-1950):
   - Keep inkless: `prohibitedInklessTopicErrors` map for diskless topic validation
   - Keep inkless: `mutable.Set[TopicPartition]()` (vs upstream's `util.HashSet`)
   - Keep inkless: Error aggregation includes `prohibitedInklessTopicErrors`

**Inkless additions preserved:**
- Check for diskless topics in transaction requests
- `prohibitedInklessTopicErrors` tracking
- `inklessSharedState.exists(s => s.metadata().isDisklessTopic(...))` validation

---

#### 5. ReplicaManager.scala ✅

**Conflicts resolved:**
1. **Imports** (lines 19-89):
   - Keep inkless: All `io.aiven.inkless.*` imports
   - Keep inkless: `kafka.cluster.Partition` (PartitionListener moved to `org.apache.kafka.server.partition`)
   - Accept upstream: `org.apache.kafka.logger.StateChangeLogger` (moved from kafka.controller)
   - Keep inkless: `LeaderAndIsr` import
   - Merge: storage.internals.log imports (keep `AsyncOffsetReadFutureHolder`, add `FetchPartitionStatus`, `LogReadResult`)

2. **Fetch response logic** (lines 1942-2004):
   - Keep inkless: `!remoteFetchInfo.isPresent && disklessFetchInfos.isEmpty` check
   - Keep inkless: `mutable.ArrayBuffer[(TopicIdPartition, FetchPartitionStatus)]` for fetchPartitionStatus
   - Keep inkless: `classicFetchInfos.foreach` pattern
   - Keep inkless: Remote fetch with diskless handling block
   - Keep inkless: `delayedResponse(fetchPartitionStatus)` call

3. **applyLocalLeadersDelta** (lines 2743-2762):
   - Keep inkless: `if (!_inklessMetadataView.isDisklessTopic(tp.topic()))` check
   - Accept upstream: New `partition.makeLeader(info.partition, isNew, ...)` signature

4. **applyLocalFollowersDelta** (lines 2778-2833):
   - Keep inkless: `if (!_inklessMetadataView.isDisklessTopic(tp.topic()))` check
   - Accept upstream: New `partition.makeFollower(info.partition, isNew, ...)` signature

**Inkless additions preserved:**
- All inkless imports for SharedState, handlers, control plane
- Diskless topic filtering in leader/follower transitions
- Split fetch handling (classic vs diskless)
- `fetchParamsWithNewMaxBytes()` for proportional maxBytes
- `fetchDisklessMessages()` for diskless data retrieval
- `delayedResponse()` with inkless DelayedFetch parameters

**Key API changes accepted from upstream:**
- `partition.makeLeader()` new signature: `(info.partition, isNew, offsetCheckpoints, topicId, directoryId)`
- `partition.makeFollower()` new signature: `(info.partition, isNew, offsetCheckpoints, topicId, directoryId)`
- Removed: `info.partition.toLeaderAndIsrPartitionState(tp, isNew)` conversion

---

### Files Deleted by Upstream
| # | File | Decision | Reason |
|---|------|----------|--------|
| 1 | EligibleLeaderReplicasIntegrationTest.java | Accept deletion | Test was removed upstream |
| 2 | AdminClientWithPoliciesIntegrationTest.scala | Accept deletion | Test was removed upstream |
| 3 | ProducerSendWhileDeletionTest.scala | Accept deletion | Test was removed upstream |

### Test Files
| # | File | Status |
|---|------|--------|
| 1 | BaseConsumerTest.scala | ✅ |
| 2 | BaseProducerSendTest.scala | ✅ |
| 3 | PlaintextConsumerTest.scala | ✅ |
| 4 | PlaintextProducerSendTest.scala | ✅ |
| 5 | DelayedFetchTest.scala | ✅ |
| 6 | AbstractCoordinatorConcurrencyTest.scala | ✅ |
| 7 | TransactionCoordinatorConcurrencyTest.scala | ✅ |
| 8 | LogConfigTest.scala | ✅ |
| 9 | KafkaApisTest.scala | ✅ |
| 10 | ReplicaManagerQuotasTest.scala | ✅ |
| 11 | ReplicaManagerTest.scala | ✅ |

---

## Phase 3: Compilation

### Build Command
```bash
./gradlew compileJava compileScala compileTestJava compileTestScala
```

### Compilation Errors Fixed

#### Main Source Fixes

| # | File | Error | Fix | Status |
|---|------|-------|-----|--------|
| 1 | build.gradle | pitest plugin 1.15.0 incompatible with Gradle 9.2.1 | Upgrade to 1.19.0-rc.3 | ✅ |
| 2 | FlattenedIterator.java | Class removed upstream but needed by inkless ConcatenatedRecords | Restored with INKLESS NOTE comment | ✅ |
| 3 | inkless/*Metrics.java (11 files) | KafkaMetricsGroup constructor changed from (Class) to (String, String) | Updated all to use `Class.getPackageName(), Class.getSimpleName()` | ✅ |
| 4 | inkless/UnifiedLog.java | ValidationResult fields now private (Java record) | Changed field access to accessor methods (e.g., `.validatedRecords()`) | ✅ |
| 5 | ReplicaManager.scala | remoteFetchInfo.isPresent (old singular) | Changed to remoteFetchInfos.isEmpty (new plural Map) | ✅ |
| 6 | ReplicaManager.scala | FetchPartitionStatus(...) case class syntax | Changed to `new FetchPartitionStatus(...)` (Java record) | ✅ |
| 7 | ReplicaManager.scala | logReadResultMap.get().foreach | Changed to null-check pattern (Java Map) | ✅ |
| 8 | ReplicaManager.scala | LogReadResult error param Optional[Throwable] | Changed to Errors (new record signature) | ✅ |
| 9 | ReplicaManager.scala | processRemoteFetch 5-arg call | Changed to processRemoteFetches (new API) | ✅ |
| 10 | DelayedFetch.scala | Unused import java.util | Removed | ✅ |
| 11 | KafkaApis.scala | authorizedPartitions mutable.Set to java.util.Set | Added `.asJava` conversion | ✅ |

#### Test Source Fixes

| # | File | Error | Fix | Status |
|---|------|-------|-----|--------|
| 1 | PlaintextConsumerTest.scala | Many missing imports | Added imports for Duration, MetricName, TopicPartition, etc. | ✅ |
| 2 | PlaintextConsumerTest.scala | QuotaType wrong package | Changed from kafka.server to org.apache.kafka.server.quota | ✅ |
| 3 | PlaintextConsumerTest.scala | SerializerImpl/DeserializerImpl | Changed to ByteArraySerializer/ByteArrayDeserializer | ✅ |
| 4 | DelayedFetchTest.scala | FetchPartitionStatus(...) | Changed to `new FetchPartitionStatus(...)` | ✅ |
| 5 | DelayedFetchTest.scala | Unused import java.util | Removed | ✅ |
| 6 | ReplicaManagerTest.scala | LogReadResult wrong import | Changed from org.apache.kafka.server to storage.internals.log | ✅ |
| 7 | ReplicaManagerTest.scala | LogReadResult missing args | Added OptionalInt.empty(), Errors.NONE | ✅ |
| 8 | ReplicaManagerTest.scala | threadNamePrefix param removed | Removed from ReplicaManager constructor call | ✅ |
| 9 | ReplicaManagerTest.scala | Duplicate LogReadResult import | Removed duplicate | ✅ |
| 10 | LogConfigTest.scala | validateWithMetadataVersion removed | Removed test, added INKLESS NOTE | ✅ |
| 11 | ReplicaManagerQuotasTest.scala | Unused createFetchPartitionStatusMap | Removed | ✅ |
| 12 | ReplicaManagerQuotasTest.scala | Unused import java.util | Removed | ✅ |
| 13 | AbstractCoordinatorConcurrencyTest.scala | Unused MetadataCache import | Removed | ✅ |
| 14 | TransactionCoordinatorConcurrencyTest.scala | Unused MetadataCache import | Removed | ✅ |

### Files Restored with INKLESS NOTE

**FlattenedIterator.java** - Removed upstream (commit 64aebb5621), retained for inkless ConcatenatedRecords:
```java
/**
 * <p><b>INKLESS NOTE:</b> This class was removed from upstream Apache Kafka in commit
 * 64aebb5621 (MINOR: remove unused FlattenedIterator #20067). It is retained here
 * specifically for inkless functionality (used by ConcatenatedRecords).
 *
 * <p>TODO(inkless): Consider migrating to an alternative implementation or inlining
 * this logic in ConcatenatedRecords to reduce divergence from upstream.
 */
```

---

## Phase 4: Testing

### Test Command
```bash
make test  # or ./gradlew :core:test
```

### Test Results

**All inkless-specific tests pass:**
- InklessClusterTest ✅
- InklessConfigsTest ✅
- InklessKRaftMetadataCacheTest ✅
- InklessMetadataViewTest ✅
- DelayedFetchTest (Inkless) ✅
- KafkaApisTest (Inkless) ✅
- ReplicaManagerTest (Inkless) ✅

### Test Failures Fixed
| # | Test Class | Test Method | Error | Fix | Status |
|---|------------|-------------|-------|-----|--------|
| 1 | ReplicaManagerTest | testReplicaAlterLogDirsMultipleReassignmentDoesNotBlockLogCleaner | ClassCastException: Boolean to Option | Clean build (`./gradlew clean`) resolved stale bytecode | ✅ |
| 2 | InklessConfigsTest | All tests | TopicBasedRemoteLogMetadataManager crash (missing bootstrap.servers) | Added `NoOpRemoteLogMetadataManager` config | ✅ |

---

## Phase 5: Verification

### Checklist
- [x] `make build` passes ✅
- [x] `make test` passes ✅
- [x] Inkless module compiles: `./gradlew :storage:inkless:build` ✅
- [x] Key inkless files exist:
  - [x] `storage/inkless/src/main/java/io/aiven/inkless/produce/Writer.java` ✅
  - [x] `docs/inkless/README.md` ✅
- [x] Version preserved in `gradle.properties`: `4.2.0-inkless-SNAPSHOT` ✅

---

## Summary

### Commits Created
| Type | Hash | Description |
|------|------|-------------|
| merge: | `60725ea3f7` | merge: apache/kafka trunk 8b119e5105 (before 4.3.0-SNAPSHOT) |
| fix(sync): | `0ea657a3c5` | fix compilation errors after upstream merge |
| docs(sync): | `161ca84c35` | document compilation fixes in SESSION-2025-11-21.md |
| docs(sync): | `08b1367317` | update SESSION-2025-11-21.md with test results |
| fix(test): | `42e9b136b8` | configure NoOpRemoteLogMetadataManager in InklessConfigsTest |
| docs(sync): | `dde0dd1c3c` | update SESSION with InklessConfigsTest fix |
| docs(sync): | `7723727ff5` | finalize SESSION-2025-11-21.md - sync complete |
| fix(sync): | `d316a3c5d6` | restore FlattenedIteratorTest for retained FlattenedIterator |

### Status: COMPLETE ✅

All phases completed successfully:
1. ~~Resolve Config/Version conflicts~~ ✅
2. ~~Resolve CI/Other conflicts~~ ✅
3. ~~Resolve Core + Inkless conflicts~~ ✅
4. ~~Handle deleted files~~ ✅
5. ~~Resolve test file conflicts~~ ✅
6. ~~Fix compilation errors~~ ✅
7. ~~Run tests~~ ✅
8. ~~Verification checklist~~ ✅

---

## Phase 6: Post-Comparison Refinements

After comparing with manual sync branch `upstream-sync-before-4.3`, applied these refinements:

### LinkedHashMap over Seq (Principle: Minimize Future Conflicts)

Changed `DelayedFetch` constructor parameters from `Seq[(TopicIdPartition, FetchPartitionStatus)]` to `util.LinkedHashMap[TopicIdPartition, FetchPartitionStatus]` to match upstream pattern:

**Files changed:**
- `core/src/main/scala/kafka/server/DelayedFetch.scala` - constructor params
- `core/src/main/scala/kafka/server/ReplicaManager.scala` - `delayedResponse` method signature
- `core/src/test/scala/integration/kafka/server/DelayedFetchTest.scala` - test setup
- `core/src/test/scala/unit/kafka/server/ReplicaManagerQuotasTest.scala` - test setup

**Rationale:** Using `util.LinkedHashMap` (upstream's choice) instead of `Seq` (inkless deviation) reduces future merge conflicts by aligning with upstream patterns.

---

## Notes
- streams/quickstart pom.xml files (3) resolved with upstream version (one-off, not documented)
- Versioning rule: `{upstream_major.minor.patch}-inkless-SNAPSHOT`
